<!DOCTYPE html>
<head>
	<title>r/place</title>
	<meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script>
		!function() {
		"use strict";

		var scripts = [
			'scripts/lib/f.js',
			'scripts/lib/pf.js',
			'scripts/lib/dom.js',
			'scripts/lib/kbd.js',

			'scripts/base/EventEmitter.js',
			'scripts/base/Defer.js',
			'scripts/base/Loader.js',
			'scripts/base/Drag.js',
			'scripts/base/Timer.js',
			'scripts/base/Bit.js',

			'scripts/Bar.js',
			'scripts/main.js'
		]
		var styles = [
			'styles/main.css',
			'styles/place.css'
		]

		var first = document.getElementsByTagName('script')[0]
		function add_script(src, callback) {
			var elem    = document.createElement('script')
			elem.type   = 'text/javascript'
			elem.src    = src
			elem.onload = callback
			first.parentNode.insertBefore(elem, first)
		}
		function add_style(href) {
			var elem  = document.createElement('link')
			elem.rel  = 'stylesheet'
			elem.href = href
			elem.type = 'text/css'
			first.parentNode.insertBefore(elem, first)
		}

		window.loadAssets = function(scripts, styles) {
			var _scripts = scripts.slice()
			,   _styles  = styles.slice()

			!function run_scripts() {
				_scripts.length && add_script(_scripts.shift(), run_scripts)
			}()
			while(_styles.length) add_style(_styles.shift())
		}

		loadAssets(scripts, styles)

		}()
	</script>
</head>

<body>
	<div class="viewport absmid">
		<canvas class="place"></div>
	</div>

	<div class="controls">

		<div class="seek-field field">
			<span class="label">time:</span>
			<span class="value">0</span>
			<div class="seek bar">
				<div class="seek pending">...loading</div>
				<div class="cursor"></div>
			</div>
		</div>

		<div class="rate-field field">
			<span class="label">rate:</span>
			<span class="value">0</span>
			<div class="rate bar">
				<div class="cursor"></div>
			</div>
		</div>

		<div class="zoom pane">
			<canvas width="28" height="28" class="hand button zoom-in"></canvas>
			<canvas width="28" height="28" class="hand button zoom-out"></canvas>
			<canvas width="28" height="28" class="hand button zoom-fit"></canvas>
		</div>
	</div>


	<div id="bscrn" class="fullscreen absmid">
		<style>
			.absmid {
				position: absolute;
				left: 0;
				top: 0;
				right: 0;
				bottom: 0;
				margin: auto;
			}
			.fullscreen {
				background-color: white;
			}
			.loading {
				width: 100px;
				height: 2px;
				padding: 1px;
				border: 1px solid #000;
				outline: 2px solid white;
				background: white;
			}
			.progress {
				width: 0px;
				height: 2px;
				background-color: #000;
			}
			.logo {
				bottom: 36px;
			}
		</style>
		<canvas id="boot" class="logo absmid" width="1000" height="1000"></canvas>
		<div class="loading absmid">
			<div id="bprog" class="progress"></div>
		</div>
	</div>
	<script>
!function() {
	var ctx = boot.getContext('2d'), ow = boot.width = 128, oh = boot.height = 128, rnd = Math.random
	var raw = 'DShDXnmUODc2UWyHITxWcYumxquQdVo/QEFcd5KRmZiXlntgRUZHYn1MS0plgJucnaGgn4RpTk9Qa4U='
	var pix = atob(raw).split('').map(n => n.charCodeAt(0)), pixw = 27, pixh = 8, len = pixw * pixh
	for(var i = len -1; i >= 0; i--) pix.push(pix.splice(Math.floor(rnd() * len), 1))
	var nd = x => 1/(Math.sqrt(Math.PI*2)*(Math.exp(2*Math.pow((x*2-1) * 1.5, 2))))
	var cs = 2, cw = ow / cs, ch = oh / cs, ndp = 1000, ndt = [], sum = 0, t = 0, image = new Set
	for(var i = 0; i < ndp; i++) { sum += nd(i / ndp) * (1 / ndp); ndt.push(sum) }
	for(var ky = 1 / sum, i = 0; i < ndp; i++) ndt[i] *= ky; ctx.scale(cs, cs)
	var nds = x => ((x * ndp) % 1) * (ndt[Math.ceil(x * ndp)] - ndt[x * ndp |0]) + ndt[x * ndp |0]

	window.bootProgress = function(value, a) {
		t = isFinite(value) ? Math.min(1, Math.max(0, value)) : 0
	}

	function loop() {
		if (t < 1) requestAnimationFrame(loop)

		ctx.fillStyle = '#000'
		for(var i = (1 - t + 0.1) * 10; i >= 0; i--) {
			var r = nds(rnd() + 0.1) * ((1 - t) * 24 + 8)
			var a = rnd() * Math.PI * 2
			var x = Math.cos(a) * r + cw/2 |0
			var y = Math.sin(a) * r + ch/2 |0
			ctx.fillRect(x, y, 1, 1)
			image.add(x + y * cw)
		}

		var array = [...image]
		ctx.fillStyle = '#fff'
		for(var i = (t * 0.6 + 0.2) * 10; i >= 0; i--) {
			var p = array.splice(rnd() * array.length |0, 1)
			ctx.fillRect(p % cw, p / cw |0, 1, 1)
		}
		image = new Set(array)

		ctx.fillStyle = '#fff'
		for(var i = (1 - t + 0.1) * 10; i >= 0; i--) {
			var p = rnd() * pixw * pixh |0
			var ix = p % pixw
			var iy = p / pixw |0
			var x = cw/2 - pixw/2 + ix
			var y = ch/2 - pixh/2 + iy

			ctx.fillRect(x, y, 1, 1)
			image.delete(p)
		}

		ctx.fillStyle = '#000'
		for(var i = (t + 0.2) * 6; i >= 0; i--) {
			var p = pix[rnd() * pix.length |0]
			var x = cw/2 - pixw/2 + p % pixw
			var y = ch/2 - pixh/2 + p / pixw |0
			ctx.fillRect(x, y, 1, 1)
			image.add(p)
		}

		bprog.style.width = Math.round(t * 100) +'%'
		bscrn.style.display = t === 1 ? 'none' : 'block'
	}
	loop()
}()
	</script>
</body>
